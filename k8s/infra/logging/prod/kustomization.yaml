apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: logging

resources:
  - ../../base/logging

# Production logging configurations
configMapGenerator:
  - name: loki-config
    behavior: merge
    files:
      - loki-config.yaml
  - name: promtail-config
    behavior: merge
    files:
      - promtail-config.yaml

# Production scaling and resources
patches:
  - target:
      kind: StatefulSet
      name: loki
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values: ["loki"]
                topologyKey: "kubernetes.io/hostname"
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: "2"
            memory: 8Gi
          requests:
            cpu: 1
            memory: 4Gi

# Production storage configuration
  - target:
      kind: PersistentVolumeClaim
      name: loki
    patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 100Gi
      - op: add
        path: /spec/storageClassName
        value: fast
